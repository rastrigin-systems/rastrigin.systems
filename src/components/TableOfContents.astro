---
// Table of Contents component - extracts h2 headings from article and creates a sticky sidebar
---

<nav class="toc" aria-label="Table of contents">
  <ul class="toc-list"></ul>
</nav>

<script>
  function initTOC() {
    const article = document.querySelector('article');
    const tocList = document.querySelector('.toc-list');
    if (!article || !tocList) return;

    // Prevent double initialization
    if (tocList.children.length > 0) return;

    const headings = Array.from(article.querySelectorAll('h2')) as HTMLElement[];
    if (headings.length === 0) {
      const toc = document.querySelector('.toc');
      if (toc) toc.classList.add('hidden');
      return;
    }

    // Ensure headings have IDs
    headings.forEach((heading, index) => {
      if (!heading.id) {
        heading.id = `heading-${index}`;
      }
    });

    // Build TOC links
    const tocLinks: HTMLAnchorElement[] = [];
    headings.forEach((heading) => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${heading.id}`;
      a.textContent = heading.textContent;
      a.className = 'toc-link';

      a.addEventListener('click', (e) => {
        e.preventDefault();
        heading.scrollIntoView({ behavior: 'smooth' });
        history.pushState(null, '', `#${heading.id}`);
        // Immediately set active on click
        setActiveLink(heading.id);
      });

      li.appendChild(a);
      tocList.appendChild(li);
      tocLinks.push(a);
    });

    const setActiveLink = (id: string) => {
      tocLinks.forEach(link => {
        if (link.getAttribute('href') === `#${id}`) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    };

    // Find active heading based on scroll position
    const updateActiveHeading = () => {
      const scrollY = window.scrollY;
      const offset = 100; // How far from top before considering "active"

      // Find the last heading that's above the offset line
      let activeHeading = headings[0];
      for (const heading of headings) {
        if (heading.offsetTop - offset <= scrollY) {
          activeHeading = heading;
        } else {
          break;
        }
      }

      // Edge case: at bottom of page, activate last heading
      const atBottom = window.innerHeight + scrollY >= document.documentElement.scrollHeight - 50;
      if (atBottom) {
        activeHeading = headings[headings.length - 1];
      }

      setActiveLink(activeHeading.id);
    };

    // Throttled scroll handler
    let ticking = false;
    const onScroll = () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActiveHeading();
          ticking = false;
        });
        ticking = true;
      }
    };

    window.addEventListener('scroll', onScroll, { passive: true });
    updateActiveHeading(); // Set initial state
  }

  // Run on page load
  initTOC();

  // Re-run on view transitions (for Astro)
  document.addEventListener('astro:page-load', initTOC);
</script>

<style is:global>
  .toc {
    position: sticky;
    top: 2rem;
    max-height: calc(100vh - 4rem);
    overflow-y: auto;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .toc-link {
    display: block;
    color: rgba(255, 255, 255, 0.28);
    text-decoration: none;
    font-size: 0.875rem;
    line-height: 1.5;
    padding-left: 0.75rem;
    border-left: 1px solid transparent;
    transition: all 0.2s ease;
  }

  .toc-link:hover {
    color: rgba(255, 255, 255, 0.6);
  }

  .toc-link.active {
    color: var(--color-accent);
    border-left-color: var(--color-accent);
  }

  .toc.hidden {
    display: none;
  }

  /* Hide on mobile */
  @media (max-width: 1024px) {
    .toc {
      display: none;
    }
  }
</style>
