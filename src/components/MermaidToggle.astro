---
// Client-side script to add SVG/Code toggle to pre-rendered mermaid diagrams
---

<script>
  function initMermaidToggles() {
    const wrappers = document.querySelectorAll('.mermaid-wrapper');

    wrappers.forEach((wrapper, index) => {
      // Skip if already initialized
      if (wrapper.classList.contains('mermaid-initialized')) return;
      wrapper.classList.add('mermaid-initialized');

      const code = wrapper.getAttribute('data-mermaid-code');
      if (!code) return;

      // Find the SVG (rehype-mermaid replaces the pre>code with SVG)
      const svg = wrapper.querySelector('svg');
      if (!svg) return;

      // Create container structure
      const container = document.createElement('div');
      container.className = 'mermaid-container';

      // Create toggle buttons
      const toggle = document.createElement('div');
      toggle.className = 'mermaid-toggle';
      toggle.innerHTML = `
        <button class="toggle-btn active" data-view="svg">SVG</button>
        <button class="toggle-btn" data-view="code">Code</button>
      `;

      // Create SVG container
      const svgContainer = document.createElement('div');
      svgContainer.className = 'mermaid-svg';
      svgContainer.appendChild(svg.cloneNode(true));

      // Create code container
      const codeContainer = document.createElement('div');
      codeContainer.className = 'mermaid-code hidden';
      codeContainer.innerHTML = `<pre><code>${escapeHtml(code)}</code></pre>`;

      // Assemble
      container.appendChild(toggle);
      container.appendChild(svgContainer);
      container.appendChild(codeContainer);

      // Replace wrapper content
      wrapper.innerHTML = '';
      wrapper.appendChild(container);

      // Add toggle event listeners
      const toggleBtns = container.querySelectorAll('.toggle-btn');
      toggleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const view = (btn as HTMLElement).dataset.view;

          toggleBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          if (view === 'svg') {
            svgContainer.classList.remove('hidden');
            codeContainer.classList.add('hidden');
          } else {
            svgContainer.classList.add('hidden');
            codeContainer.classList.remove('hidden');
          }
        });
      });
    });
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Run on page load
  initMermaidToggles();

  // Re-run on view transitions (for Astro)
  document.addEventListener('astro:page-load', initMermaidToggles);
</script>

<style is:global>
  .mermaid-wrapper {
    margin: 1.5rem 0;
  }

  .mermaid-container {
    border-radius: 14px;
    overflow: hidden;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
    box-shadow:
      0 1px 0 rgba(255, 255, 255, 0.03) inset,
      0 12px 40px rgba(0, 0, 0, 0.45);
  }

  .mermaid-toggle {
    display: flex;
    gap: 0;
    background: rgba(0, 0, 0, 0.2);
  }

  .mermaid-toggle .toggle-btn {
    padding: 0.5rem 1rem;
    background: transparent;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    font-size: 0.8rem;
    font-family: inherit;
    transition: color 0.2s, background 0.2s;
  }

  .mermaid-toggle .toggle-btn:hover {
    color: var(--color-text);
  }

  .mermaid-toggle .toggle-btn.active {
    color: var(--color-accent);
    box-shadow: inset 0 -2px 0 var(--color-accent);
  }

  .mermaid-svg {
    padding: 1.5rem;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100px;
    overflow-x: auto;
  }

  .mermaid-svg svg {
    height: auto;
    min-width: fit-content;
  }

  .mermaid-code {
    padding: 0;
  }

  .mermaid-code pre {
    margin: 0;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.15);
    overflow-x: auto;
    border-radius: 0;
  }

  .mermaid-code code {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--color-text-secondary);
  }

  .mermaid-container .hidden {
    display: none !important;
  }
</style>
