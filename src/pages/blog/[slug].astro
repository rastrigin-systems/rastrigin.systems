---
import Layout from '../../layouts/Layout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import MermaidToggle from '../../components/MermaidToggle.astro';
import DevEditor from '../../components/DevEditor.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => {
    // Filter out drafts in production
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

function formatDate(dateStr: string) {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<Layout title={post.data.title} description={post.data.excerpt} isPost={true}>
  <div class="blog-layout">
    <article class="prose">
      <header class="mb-8">
        <h1 class="text-3xl font-bold mb-2">{post.data.title}</h1>
        {post.data.subtitle && (
          <p class="text-lg text-[var(--color-text-muted)] mt-1 mb-3">{post.data.subtitle}</p>
        )}
        <time class="text-[var(--color-text-muted)] text-sm">{formatDate(post.data.date)}</time>
      </header>

      <Content />
    </article>

    <aside class="toc-sidebar">
      <TableOfContents />
    </aside>
  </div>

  <MermaidToggle />
  <DevEditor slug={post.id} />
</Layout>

<style>
  .blog-layout {
    position: relative;
  }

  .toc-sidebar {
    display: none;
  }

  /* Show TOC on larger screens, aligned with first section */
  @media (min-width: 1280px) {
    .toc-sidebar {
      display: block;
      position: fixed;
      left: calc(50% + 21rem + 4rem);
      top: 460px;
      width: 14rem;
    }
  }
</style>
